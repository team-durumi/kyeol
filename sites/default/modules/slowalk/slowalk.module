<?php
/**
 * Created by PhpStorm.
 * User: js
 * Date: 2019-03-05
 * Time: 00:06
 */

define('__SLOWALK__', drupal_get_path('module', 'slowalk'));

/**
 * Implements hook_menu().
 */
function slowalk_menu()
{
    $items['admin/webzine'] = array(
        'title' => '유지관리',
        'description' => '웹진 어드민 페이지입니다',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('wz_main_callback'),
        'access arguments' => array('access administrator')
    );

    $items['admin/webzine/mainpage-settings'] = array(
        'title' => '메인 페이지 설정',
        'description' => '메인 페이지 구성 요소를 설정할 수 있습니다',
        'type' => MENU_DEFAULT_LOCAL_TASK,
        'weight' => 0
    );

    $items['admin/webzine/slide'] = array(
        'title' => '메인 슬라이드',
        'description' => '메인페이지 슬라이드 설정 페이지입니다.',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('wz_slide_callback'),
        'access arguments' => array('access administrator'),
        'type' => MENU_LOCAL_TASK,
        'weight' => 1
    );

    $items['ajax/webzine'] = array(
        'title' => 'Ajax',
        'description' => '',
        'page callback' => 'webzine_ajax_callback',
        'access arguments' => array('access administrator'),
        'type' => MENU_CALLBACK,
        'file' => 'slowalk_ajax.php'
    );

    return $items;
}

function wz_main_callback($form, &$form_state)
{
    global $base_url;
    drupal_add_js(array(
        'Webzine' => array('ajaxUrl' => $base_url . '/ajax/webzine')
    ), 'setting');

    $form['fieldset'] = array(
        '#type' => 'fieldset',
        '#title' => '메인 콘첸츠 선택'
    );

    $vol = taxonomy_vocabulary_machine_name_load('vol');
    $volTerms = taxonomy_get_tree($vol->vid);
    $volOptions = array('_none_' => '- 선택 -');
    krsort($volTerms);
    foreach($volTerms as $term) {
        $volOptions[$term->tid] = $term->name;
    }

    $form['fieldset']['wz_main_vol'] = array(
        '#type' => 'select',
        '#title' => 'Vol.',
        '#options' => $volOptions,
        '#default_value' => variable_get('wz_main_vol', '_none_'),
        '#required' => TRUE
    );

    $form['fieldset']['wz_main_features'] = array(
        '#type' => 'checkboxes',
        '#title' => '기사 분류',
        '#options' => array(
            2 => '연구자의 말',
            3 => '논평',
            4 => '에세이',
            5 => '자료해제',
            6 => '연구자와 지원단체',
            7 => '인터뷰'
        ),
        '#default_value' => variable_get('wz_main_features', array()),
        '#required' => TRUE
    );

    $form['fieldset']['grid'] = array(
        '#type' => 'item',
        '#title' => t('Features'),
        '#markup' => '<div id="first" class="item"></div><div id="second" class="item"></div>'
    );

    $form['fieldset']['lists'] = array(
        '#type' => 'item',
        '#title' => t('Articles'),
        '#markup' => '<div id="lists"></div>'
    );

    $form['wz_main_first_feature'] = array(
        '#type' => 'hidden',
        '#default_value' => variable_get('wz_main_first_feature', '')
    );

    $form['wz_main_second_feature'] = array(
        '#type' => 'hidden',
        '#default_value' => variable_get('wz_main_second_feature', '')
    );

    $form['#attached'] = array(
        'js' => array(__SLOWALK__ . '/js/webzine.js' => array('scope' => 'footer', 'type' => 'file')),
        'css' => array(__SLOWALK__ . '/css/webzine.css')
    );

    return system_settings_form($form);
}

function wz_slide_callback($form, &$form_state)
{
    $form['wz_slide_count'] = array(
        '#type' => 'select',
        '#title' => '슬라이드 개수 설정',
        '#options' => drupal_map_assoc(array(1,2,3,4,5)),
        '#default_value' => variable_get('wz_slide_count', 5),
        '#required' => TRUE,
    );

    for($i=1; $i<=5; $i++) {
        $form['fieldset-'.$i.'-slide'] = array(
            '#type' => 'fieldset',
            '#title' => '슬라이드 #'.$i,
        );

        $form['fieldset-'.$i.'-slide']['slide_'.$i.'_title'] = array(
            '#type' => 'textfield',
            '#title' => '제목',
            '#default_value' => variable_get('slide_'.$i.'_title', ''),
        );

        $form['fieldset-'.$i.'-slide']['slide_'.$i.'_body'] = array(
            '#type' => 'textarea',
            '#title' => '내용',
            '#default_value' => variable_get('slide_'.$i.'_body', ''),
        );

        $form['fieldset-'.$i.'-slide']['slide_'.$i.'_image'] = array(
            '#type' => 'managed_file',
            '#title' => '이미지',
            '#default_value' => variable_get('slide_'.$i.'_image', ''),
        );

        $form['fieldset-'.$i.'-slide']['slide_'.$i.'_link'] = array(
            '#type' => 'textfield',
            '#title' => '링크',
            '#default_value' => variable_get('slide_'.$i.'_link', ''),
        );

        $form['fieldset-'.$i.'-slide']['slide_'.$i.'_blank'] = array(
            '#type' => 'checkbox',
            '#title' => '새창열기',
            '#default_value' => variable_get('slide_'.$i.'_blank', '')
        );
    }

    $form['#attached']['js'] = array(__SLOWALK__ . '/js/slide.js' => array('scope' => 'footer', 'type' => 'file'));

    return system_settings_form($form);
}

function wz_slide_callback_validate($form, &$form_state)
{
    $start = $form_state['values']['wz_slide_count'] + 1;
    for($i = $start; $i <= 5; $i++) {
        $form_state['values']['slide_'.$i.'_title'] = '';
        $form_state['values']['slide_'.$i.'_body'] = '';
        if($form_state['values']['slide_'.$i.'_image']) {
            $file = file_load($form_state['values']['slide_'.$i.'_image']);
            file_delete($file);
        }
        $form_state['values']['slide_'.$i.'_image'] = 0;
        $form_state['values']['slide_'.$i.'_link'] = '';
        $form_state['values']['slide_'.$i.'_blank'] = 0;
    }
}